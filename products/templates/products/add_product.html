{% extends "base.html" %}
{% load static %}

{% block page_header %}
    <div class="container header-container" style="padding-top: 150px;">
        <div class="row">
            <div class="col"></div>
        </div>
    </div>
{% endblock %}

{% block content %}
    <div class="overlay"></div>
    <div class="container">
        <div class="row">
            <div class="col-12 col-md-6">
                <hr>
                <h2 class="logo-font mb-4">Product Management</h2>
                <h5 class="text-muted">Add a Product</h5>
                <hr>
            </div>
        </div>

        <div class="row">
            <div class="col-12 col-md-6">
                <form method="POST" action="{% url 'add_product' %}" class="form mb-2" enctype="multipart/form-data" id="product-form">
                    {% csrf_token %}
                    
                    <!-- Display non-field errors -->
                    {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {% for error in form.non_field_errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <!-- Render each field -->
                    {% for field in form %}
                        <div class="form-group {% if field.errors %}has-error{% endif %}">
                            {% if field.name != 'image' %}
                                <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                                {% if field.field.required %}
                                    <span class="text-danger">*</span>
                                {% endif %}
                            {% endif %}
                            
                            {{ field }}
                            
                            {% if field.help_text %}
                                <small class="form-text text-muted">{{ field.help_text }}</small>
                            {% endif %}
                            
                            {% if field.errors %}
                                <div class="text-danger">
                                    {% for error in field.errors %}
                                        <small>{{ error }}</small><br>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                    
                    <!-- Image preview container -->
                    <div class="mb-3" id="image-preview-container" style="display: none;">
                        <label>Image Preview:</label>
                        <div class="border p-2">
                            <img id="image-preview" src="#" alt="Preview" style="max-height: 200px; display: none;"/>
                            <p id="filename" class="mt-2 mb-0"></p>
                        </div>
                    </div>

                    <div class="text-right mt-4">
                        <a class="btn btn-outline-black rounded-0" href="{% url 'products' %}">Cancel</a>
                        <button class="btn btn-black rounded-0" type="submit">Add Product</button>
                    </div>
                </form>
            </div>            
        </div>
    </div>
{% endblock %}

{% block postloadjs %}
    {{ block.super }}
    <script>
        // Wait for DOM to be fully loaded
        document.addEventListener("DOMContentLoaded", function() {
            // Initialize jQuery only when it's available
            if (window.jQuery) {
                $(document).ready(function($) {
                    // Image upload preview functionality
                    $('#id_image').change(function() {
                        const file = this.files[0];
                        const previewContainer = $('#image-preview-container');
                        const preview = $('#image-preview');
                        const filename = $('#filename');
                        
                        if (file) {
                            const reader = new FileReader();
                            
                            reader.onload = function(e) {
                                preview.attr('src', e.target.result);
                                preview.show();
                                previewContainer.show();
                                filename.text(`Selected file: ${file.name}`);
                            }
                            
                            reader.readAsDataURL(file);
                        } else {
                            preview.hide();
                            previewContainer.hide();
                            filename.text('');
                        }
                    });

                    // Form validation
                    $('#product-form').submit(function(e) {
                        let valid = true;
                        
                        // Check required fields
                        $(this).find('[required]').each(function() {
                            if (!$(this).val()) {
                                valid = false;
                                $(this).addClass('is-invalid');
                                $(this).after('<div class="invalid-feedback">This field is required</div>');
                            }
                        });
                        
                        if (!valid) {
                            e.preventDefault();
                            $('html, body').animate({
                                scrollTop: $('.is-invalid').first().offset().top - 100
                            }, 500);
                        }
                    });
                    
                    // Remove validation errors on input
                    $('input, select, textarea').on('input change', function() {
                        $(this).removeClass('is-invalid');
                        $(this).next('.invalid-feedback').remove();
                    });
                });
            } else {
                console.error('jQuery is not loaded');
            }
        });
    </script>
{% endblock %}